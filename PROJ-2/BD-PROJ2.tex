\documentclass[11pt,a4paper]{article}
 
% use latex in portuguese
\usepackage[portuguese]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

\usepackage{authblk}
\usepackage{listings}
\usepackage{enumitem}
\usepackage{graphicx}
\usepackage[hmargin=2cm,vmargin=3.5cm,bmargin=3cm]{geometry}

% for code snippets
\usepackage{listings}


\newcommand{\select}{\mbox{\Large$\sigma$}}

\pagenumbering{arabic}

\title{\textbf{Projecto de Bases de Dados, Parte 2}}
 
\author{Bruno Cardoso (72619), Lídia Freitas (78559) e Rodrigo Bernardo (78942)} 

\affil{Instituto Superior Técnico}

\begin{document}

% \date{11 de Dezembro de 2015}
\date {\today}

\maketitle

\centerline{\includegraphics[width=0.4\textwidth]{ist-simbolo.jpg}}

\begin{description}[noitemsep]
	\item \centering{Grupo 17}
	\item Turno: Quinta-Feira, às 08h00, LAB 14
	\item 25 horas de trabalho por aluno.
\end{description}

\newpage

\tableofcontents
\newpage

\section{Introdução}
\newpage

\section{Consultas SQL}
% http://sqlformat.org/
\begin{enumerate}[label=(\alph*)]
	\item Quais são os utilizadores que falharam o login mais vezes do que tiveram sucesso?
		\begin{lstlisting}[language=SQL]
SELECT userid
FROM login AS l
WHERE sucesso = 0
GROUP BY userid
HAVING count(*) > ALL
    (SELECT count(*)
     FROM login AS l1
     WHERE sucesso = 1
         AND l1.userid =l.userid);
		\end{lstlisting}

	\item Quais são os registos que aparecem em todas as paginas de um utilizador?
	
	A query utiliza \textit{ID\_USER} que deve ser substituido pelo id do utilizador desejado (userid):
		\lstset{emph={ID_USER}, emphstyle=\itshape} % da enfase a palavra ID_USER
		\begin{lstlisting}[language=SQL]
SELECT r.regid
FROM reg_pag AS r
WHERE  r.ativa=1 and r.userid = ID_USER
    AND NOT EXISTS
        (SELECT r2.pageid
         FROM reg_pag AS r2
         WHERE r2.ativa = 1 and r2.userid = ID_USER 
             AND r.regid NOT IN
                 (SELECT r3.regid
                  FROM reg_pag AS r3
                  WHERE r3.ativa = 1 and r3.userid= ID_USER
                      AND r3.regid = r.regid
                      AND r3.pageid = r2.pageid));
        		\end{lstlisting}
	\item Quais os utilizadores que tem o maior número médio de registos por página?
		\begin{lstlisting}[language=SQL]
SELECT userid
FROM reg_pag
WHERE ativa=1
GROUP BY userid
HAVING count(*) / count(DISTINCT pageid) >= all
    (SELECT count(*) / count(DISTINCT pageid)
     FROM reg_pag
     WHERE ativa=1
     GROUP BY userid);
		\end{lstlisting}
	
	\item Quais os utilizadores que, em todas as suas páginas, têm registos de todos os tipos de registos que criaram?
\end{enumerate}

\newpage

\section{Restrições de Integridade}
\newpage

\section{Formas Normais}\newpage
\newpage

\section{Indices}
\newpage

\section{Transações}
\newpage

\section{Data Warehouse}
\newpage

\section{Conclusão}
\newpage




\end{document}